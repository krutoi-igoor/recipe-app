name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest
    continue-on-error: true
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: recipe_app_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci --no-progress || npm install --no-progress
        working-directory: backend

      - name: Run Prisma migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/recipe_app_test
        run: npx prisma migrate deploy --skip-generate || true
        working-directory: backend

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/recipe_app_test
          NODE_ENV: test
        run: npm run test:ci
        working-directory: backend

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --no-progress || npm install --no-progress
        working-directory: frontend

      - name: Run tests
        run: npm test
        working-directory: frontend

  deploy-to-ubuntu-host:
    name: Deploy to Ubuntu host
    runs-on: self-hosted
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main'
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend deps (prod)
        run: npm ci --omit=dev --no-progress
        working-directory: backend

      - name: Install frontend deps and build
        run: |
          npm ci --no-progress
          npm run build
        working-directory: frontend

      - name: Sync repository to deploy path
        run: |
          mkdir -p ${DEPLOY_PATH}
          rsync -az --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='_work' \
            ./ ${DEPLOY_PATH}/

      - name: Install and build backend
        run: |
          cd ${DEPLOY_PATH}/backend
          npm ci --omit=dev --no-progress
          
          # Create .env file if it doesn't exist
          if [ ! -f .env ]; then
            cp ../.env .env || cat > .env << 'ENVEOF'
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/recipe_app
REDIS_URL=redis://localhost:6379
JWT_SECRET=change_me
JWT_REFRESH_SECRET=change_me_too
AI_PROVIDER=openai
OPENAI_API_KEY=
SMTP_URL=smtp://user:pass@smtp.example.com:587
ENVEOF
          fi
          
          # Check if PM2 is installed, if not install it
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Delete existing PM2 process if it exists, then start fresh
          pm2 delete recipe-app || true
          pm2 start src/server.js --name recipe-app --cwd ${DEPLOY_PATH}/backend
          pm2 save
          
          # Ensure PM2 resurrects on reboot
          pm2 startup systemd -u ${DEPLOY_USER} --hp /home/${DEPLOY_USER} || true

      - name: Install and build frontend
        run: |
          cd ${DEPLOY_PATH}/frontend
          npm ci --no-progress
          npm run build
          
      - name: Deploy static files
        run: |
          mkdir -p ${DEPLOY_PATH}/static
          rm -rf ${DEPLOY_PATH}/static/*
          cp -r ${DEPLOY_PATH}/frontend/dist/* ${DEPLOY_PATH}/static/
